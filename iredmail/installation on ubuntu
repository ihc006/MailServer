##############  mail server   IRedMail ###########
# https://umitturanli.com.tr/iredmail-kurulumu-ve-yapilandirmasi-nasil-yapilir/
# https://www.mshowto.org/linux-iredmail-server-kurulumu-nasil-yapilir.html

sudo apt update && sudo apt upgrade -y

sudo apt install -y curl wget unzip net-tools dnsutils gzip dialog

sudo hostnamectl set-hostname mail.test.com

nano /etc/hostname

mail

nano /etc/hosts

127.0.0.1 localhost

127.0.1.1 mail.test.com mail

127.0.0.1 mail.test.com mail localhost localhost.localdomain  # hostname -f yaptÄ±ÄŸÄ±nÄ±zda sonuÃ§ olarak mail.alanadÄ±nÄ±z.com gÃ¶rmÃ¼yorsanÄ±z sunucuyu reboot edelim.

 hostname â€“fqdn   #  test

mkdir /iredmail
cd /iredmail

wget https://github.com/iredmail/iRedMail/archive/refs/tags/1.7.1.tar.gz
tar zxf iRedMail-x.y.z.tar.gz
cd /root/iRedMail-x.y.z/
bash iRedMail.sh                     # 5-15 dakika kadar sÃ¼rebilecektir.



Default mail storage path      :   (VarsayÄ±lan olarak /var/vmail klasÃ¶rÃ¼ gelmektedir)
Choose default web server      :   Ä°lgili alanda varsayÄ±lan web sunucusu seÃ§ilmelidir.  Nginx ve Apache
MySQL / Mariadb                :   kullanÄ±cÄ±sÄ± iÃ§in parolayÄ± tanÄ±mlayÄ±nÄ±z.
Your first virtual domain name :   alanÄ±ndan domain adÄ±nÄ±zÄ± tanÄ±mlayÄ±nÄ±z. Bundan sonra eklenecek domainler web arayÃ¼zÃ¼nden eklenebilir.
                                   Az Ã¶nce eklemiÅŸ olduÄŸumuz domain adÄ± iÃ§in â€ postmaster â€ e-posta kullanÄ±cÄ± parolasÄ±nÄ± tanÄ±mlayÄ±nÄ±z.
								 
Optional components : TÃ¼m bileÅŸenleri kurmanÄ±zÄ± Ã¶neririz.

Configuration complated : Konfigurasyon iÅŸlemleri tamamlandÄ±. Ä°lgili ekrandaki sorularÄ± â€ Y â€œe tuÅŸlayarak onaylayÄ±nÄ±z.

**************************** WARNING ***********************************
*************************************************************************
* *
* Below file contains sensitive infomation (username/password), please *
* do remember to *MOVE* it to a safe place after installation. *
* *
* * /var/www/html/webmail/iRedMail-0.9.0/config
* *
*************************************************************************
< Question > Continue? [y|N]y

< Question > Would you like to use firewall rules provided by iRedMail?
< Question > File: /etc/default/iptables, with SSHD port: 22. [Y|n]Y
< INFO > Copy firewall sample rules: /etc/default/iptables.
< Question > Restart firewall now (with SSHD port 22)? [y|N]y

Kurulum tamamlandÄ± ğŸ™‚

Webmail:

mail.alanadÄ±nÄ±z.com

Admin Panel:

mail.alanadÄ±nÄ±z.com/iredadmin


#########################################################################################################
# https://www.classbilisim.com.tr/index.php?rp=/knowledgebase/132/Ubuntu-20.0418.04-uzerine-iRedMail-kurulumu.html


sudo apt -y update && sudo apt -y upgrade

sudo systemctl reboot


sudo hostnamectl set-hostname mail.test.com
export HOSTNAME="email.classbilisim.com"
sudo hostnamectl set-hostname $HOSTNAME --static
sudo hostnamectl set-hostname $HOSTNAME --transient

$ sudo nano /etc/hosts
188.40.225.2 mail.hirebestengineers.com


   # DNS Ã§Ã¶zÃ¼mlemesini saÄŸlamak iÃ§in Ã¶nce dns-utils paketini kurun.

sudo apt -y install curl wget unzip net-tools dnsutils gzip dialog

https://github.com/iredmail/iRedMail/archive/refs/tags/1.7.1.tar.gz

tar xvf 1.7.1.tar.gz

cd iRedMail-*/

sudo chmod +x iRedMail.sh

sudo ./iRedMail.sh




sudo apt install software-properties-common
sudo add-apt-repository ppa:certbot/certbot -y
sudo apt install certbot -y


sudo certbot certonly --webroot --agree-tos --email you@example.com -d mail.your-domain.com -w /var/www/html/

sudo nano /etc/nginx/sites-enabled/00-default.conf

                # kare iÅŸaretini silelim..

listen [::]:80;

                # Kaydedelim ve sonrasÄ±nda diÄŸer dosyaya geÃ§elim 

sudo nano /etc/nginx/sites-enabled/00-default-ssl.conf

                # EÄŸer dosyanÄ±n iÃ§inde aÅŸaÄŸÄ±daki gibi http2 yoksa ekleyelim.
listen 443 ssl http2;
listen [::]:443 ssl http2;



sudo nginx -t
sudo systemctl reload nginx 
                # TLS sertifikasÄ± almak iÃ§in aÅŸaÄŸÄ±daki komutu tekrar Ã§alÄ±ÅŸtÄ±rÄ±n.
sudo certbot certonly --webroot --agree-tos --email you@example.com -d mail.your-domain.com -w /var/www/html/


sudo nano /etc/nginx/templates/ssl.tmpl
                # AÅŸaÄŸÄ±daki 2 satÄ±rÄ± bulun.
ssl_certificate /etc/ssl/certs/iRedMail.crt;
ssl_certificate_key /etc/ssl/private/iRedMail.key;
                 
				 # BunlarÄ± ÅŸununla deÄŸiÅŸtirin:
ssl_certificate /etc/letsencrypt/live/mail.your-domain.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/mail.your-domain.com/privkey.pem;


                  # DosyayÄ± kaydedin ve kapatÄ±n. ArdÄ±ndan nginx yapÄ±landÄ±rmasÄ±nÄ± test edin ve yeniden yÃ¼kleyin.

sudo nginx -t

sudo systemctl reload nginx

                    # Sunucuyu yeniden baÅŸlatalÄ±m. BaÅŸarÄ±lÄ± bir ÅŸekilde kurulum tamamlamÄ±ÅŸ ssl yapÄ±landÄ±rÄ±lmÄ±ÅŸ olduk.
					
#########################################################################################################
# https://www.kodkoda.com/t/iredmail-ile-ubuntu-18-04te-posta-sunucusu-kurulumu-yapilandirmasi/199
#  kodkoda iRedMail-kurulumu.html


$ sudo apt -y update && sudo apt -y upgrade

$ sudo hostnamectl set-hostname mail.test.com
$ sudo systemctl reboot

$ sudo nano /etc/hostname
mail.dijicamp.com

$ sudo cat /etc/hosts
127.0.0.1 localhost
127.0.1.1 mail.dijicamp.com dijicamp.com dijicamp        # hostname -f yaptÄ±ÄŸÄ±nÄ±zda sonuÃ§ olarak mail.alanadÄ±nÄ±z.com gÃ¶rmÃ¼yorsanÄ±z sunucuyu reboot edelim.

$ sudo hostname â€“fqdn   #  test

$ export HOSTNAME="mail.dijicamp.com"
$ sudo hostnamectl set-hostname $HOSTNAME --static
$ sudo hostnamectl set-hostname $HOSTNAME --transient

$ sudo apt -y update && sudo apt -y upgrade

$  sudo mkdir /iredmail
$ cd /iredmail



   # DNS Ã§Ã¶zÃ¼mlemesini saÄŸlamak iÃ§in Ã¶nce dns-utils paketini kurun.

$ sudo apt -y install curl wget unzip net-tools dnsutils gzip dialog

$ sudo wget https://github.com/iredmail/iRedMail/archive/refs/tags/1.7.1.tar.gz

$ sudo tar xvf 1.7.1.tar.gz

$ cd iRedMail-*/

$ sudo chmod +x iRedMail.sh

$ sudo ./iRedMail.sh


           # ssl activation

$ sudo apt install software-properties-common -y
$ sudo add-apt-repository ppa:certbot/certbot -y

$ sudo apt -y update

$ sudo apt install certbot -y


$ sudo certbot certonly --webroot --agree-tos --email ramacar@gmail.com -d mail.dijicamp.com -w /var/www/html/

$ sudo nano /etc/nginx/sites-enabled/00-default.conf

                # kare iÅŸaretini silelim..

listen [::]:80;

                # Kaydedelim ve sonrasÄ±nda diÄŸer dosyaya geÃ§elim 

sudo nano /etc/nginx/sites-enabled/00-default-ssl.conf

                # EÄŸer dosyanÄ±n iÃ§inde aÅŸaÄŸÄ±daki gibi http2 yoksa ekleyelim.
listen 443 ssl http2;
listen [::]:443 ssl http2;   # bu satiri ekledik



$ sudo nginx -t

$ sudo systemctl reload nginx 
                # TLS sertifikasÄ± almak iÃ§in aÅŸaÄŸÄ±daki komutu tekrar Ã§alÄ±ÅŸtÄ±rÄ±n.
sudo certbot certonly --webroot --agree-tos --email you@example.com -d mail.your-domain.com -w /var/www/html/


$ sudo nano /etc/nginx/templates/ssl.tmpl
                # AÅŸaÄŸÄ±daki 2 satÄ±rÄ± bulun.
ssl_certificate /etc/ssl/certs/iRedMail.crt;
ssl_certificate_key /etc/ssl/private/iRedMail.key;
                 
				 # BunlarÄ± ÅŸununla deÄŸiÅŸtirin:
ssl_certificate /etc/letsencrypt/live/mail.your-domain.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/mail.your-domain.com/privkey.pem;


                  # DosyayÄ± kaydedin ve kapatÄ±n. ArdÄ±ndan nginx yapÄ±landÄ±rmasÄ±nÄ± test edin ve yeniden yÃ¼kleyin.

$ sudo nginx -t

$ sudo systemctl reload nginx


                    # Sunucuyu yeniden baÅŸlatalÄ±m. BaÅŸarÄ±lÄ± bir ÅŸekilde kurulum tamamlamÄ±ÅŸ ssl yapÄ±landÄ±rÄ±lmÄ±ÅŸ olduk.
										
          # Postfix ve Dovecotâ€™a TLS sertifikasÄ±nÄ± yÃ¼kleyin

$ sudo nano /etc/postfix/main.cf

smtpd_tls_key_file = /etc/letsencrypt/live/mail.sizinalanadiniz.com/privkey.pem
smtpd_tls_cert_file = /etc/letsencrypt/live/mail.sizinalanadiniz.com/cert.pem
smtpd_tls_CAfile = /etc/letsencrypt/live/mail.sizinalanadiniz.com/chain.pem

$ sudo systemctl reload postfix


$ sudo nano /etc/dovecot/dovecot.conf
    #Bu satirlari
ssl_cert = </etc/ssl/certs/iRedMail.crt
ssl_key = </etc/ssl/private/iRedMail.key
   # bunlar ile degistirin

ssl_cert = </etc/letsencrypt/live/mail.sizinalanadiniz.com/fullchain.pem
ssl_key = </etc/letsencrypt/live/mail.sizinalanadiniz.com/privkey.pem

$ sudo systemctl reload dovecot


############ Kotroller  ###################
*** DKIM KaydÄ±***

$ sudo amavisd-new showkeys 

Ã–rnek Ã§Ä±ktÄ±:

; key#1 2048 bits, i=dkim, d=sizinalanadiniz.com, /var/lib/dkim/sizinalanadiniz.com.pem
dkim._domainkey.sizinalanadiniz.com.    3600 TXT (
  "v=DKIM1; p="
  "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAushN12z+XYCwmB+9ybgq"
  "6OAU5Mnpta5NiBgVUqnvrFCD16A72hoVt5N8kruNy4xXbs/ybAEqewGXJDtqpRz9"
  "kpxkQogca/jlU4PMoKcptuMW9FMbDjoXNAO5qfnTjyDTPkWBjIohd+ICWUoHiHwC"
  "DTb+dhPR9Co4PPEIeLHIYEnpBWd0iNSXS6qEzZWUzBk1Yb4jXgZE7sbcyBvumJl/"
  "V6HopUBHhg5LXmW/DGHjG+H2B8uSASBYlbH9qFEQC/D78OYI69je79buOBPpF6EP"
  "3v41G0e8qto31UgET76g7n82H1bXLHM0HG4ZUYWSSy1QVL5ibLl257PsvyAoFXvM"
  "gwIDAQAB")

  # DNS yÃ¶neticinizde bir TXT kaydÄ± oluÅŸturun, ad alanÄ±na dkim._domainkey yazÄ±n. 
  # Parantez iÃ§indeki her ÅŸeyi kopyalayÄ±n ve deÄŸer alanÄ±na yapÄ±ÅŸtÄ±rÄ±n. TÃ¼m Ã§ift tÄ±rnak ve satÄ±r sonlarÄ±nÄ± silin.

*** PTR kaydÄ± ***

 # Bir PTR kaydÄ±, bir IP adresini FQDN (tam etki alanÄ± adÄ±) ile eÅŸleÅŸtirir. A kaydÄ±nÄ±n karÅŸÄ±lÄ±ÄŸÄ± ve SPAM gÃ¶nderenleri engellemeye yardÄ±mcÄ± olabilecek ters DNS aramasÄ± iÃ§in kullanÄ±lÄ±r. 
 # GÃ¶nderen sunucuda PTR kaydÄ± bulunmazsa, birÃ§ok SMTP sunucusu e-postalarÄ± reddeder.
 # Bir IP adresi iÃ§in PTR kaydÄ±nÄ± kontrol etmek iÃ§in ÅŸu komutu Ã§alÄ±ÅŸtÄ±rÄ±n:

$ dig -x 49.12.34.61 +short    #  Olmadi ??????

mail.sizinalanadiniz.com


*** SPF kaydÄ± ***

# SPF (Sender Policy Framework) kaydÄ±, hangi ana bilgisayarlarÄ±n veya 
# IP adresinin bir etki alanÄ± adÄ±na e-posta gÃ¶ndermesine izin verileceÄŸini belirtir. 
# YalnÄ±zca kendi e-posta sunucunuzun etki alanÄ±nÄ±z iÃ§in e-posta gÃ¶ndermesine izin vermelisiniz. 
# DNS yÃ¶netim arayÃ¼zÃ¼nÃ¼zde, aÅŸaÄŸÄ±daki gibi yeni bir TXT kaydÄ± oluÅŸturun.


v=spf1 mx ~all


# TXT bu deÄŸerin bir TXT kaydÄ± olduÄŸunu gÃ¶sterir.
# Ana etki alanÄ± adÄ±nÄ± temsil etmek iÃ§in ad alanÄ±na @ iÅŸaretini girin.
# v = spf1, bunun bir SPF kaydÄ± olduÄŸunu ve sÃ¼rÃ¼mÃ¼n SPF1 olduÄŸunu gÃ¶sterir.
# mx , MX kayÄ±tlarÄ±nda listelenen tÃ¼m ana bilgisayarlarÄ±n etki alanÄ±nÄ±z iÃ§in e-posta gÃ¶ndermesine izin verildiÄŸi ve diÄŸer tÃ¼m ana bilgisayarlarÄ±n izin verilmediÄŸi anlamÄ±na gelir.
# ~all , alan adÄ±nÄ±zdan gelen e-postalarÄ±n yalnÄ±zca SPF kaydÄ±nda belirtilen ana bilgisayarlardan gelmesi gerektiÄŸini gÃ¶sterir. DiÄŸer ana bilgisayarlardan gelen e-postalar sahte olarak iÅŸaretlenir.
# SPF kaydÄ±nÄ±zÄ±n genel internete yayÄ±lÄ±p yayÄ±lmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in, aÅŸaÄŸÄ±daki gibi Linux makinenizdeki dig yardÄ±mcÄ± programÄ±nÄ± kullanabilirsiniz:

$ dig sizinalanadiniz.com txt   # ok



*** DMARC kaydÄ± ***
 # DMARC (Etki alanÄ± tabanlÄ± ileti kimlik doÄŸrulamasÄ±) e-postalarÄ± tanÄ±mlamak ve alan adÄ±nÄ±zÄ±n e-posta sahtekarlÄ±ÄŸÄ± ile 
 # kullanÄ±lmasÄ±nÄ± Ã¶nlemek iÃ§in yardÄ±mcÄ± olur.
 # Bir DMARC kaydÄ± oluÅŸturmak iÃ§in DNS yÃ¶neticinize gidin ve bir TXT kaydÄ± ekleyin. 
 # Ad alanÄ±na _dmarc girin. DeÄŸer alanÄ±na aÅŸaÄŸÄ±dakileri girin:


v=DMARC1; p=none; pct=100; rua=mailto:dmarc-reports@sizinalanadiniz.com

####  Letâ€™s Encrypt sertifikasÄ±nÄ±n otomatik olarak yenilenmesini #####

$ sudo certbot renew  

$ sudo certbot renew --dry-run    # yenilemeyi test etmek icin 



